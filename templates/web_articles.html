{% extends 'base.html' %}

{% block title %}Kelola Artikel - Admin{% endblock %}

{% block extra_css %}
<style>
    .page-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .page-header h1 { font-size: 1.8rem; font-weight: 700; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 12px; }
    .page-header i { color: #3b82f6; }
    .header-card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
    .header-info h3 { font-size: 1.1rem; font-weight: 600; color: #1e293b; margin: 0 0 4px 0; }
    .header-info p { font-size: 0.9rem; color: #64748b; margin: 0; }
    .btn { padding: 10px 18px; border-radius: 8px; border: none; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    .table-card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .table { width: 100%; border-collapse: collapse; }
    .table thead { background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
    .table th { padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.85rem; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; user-select: none; }
    .table th:hover { background: #e2e8f0; }
    .table th.sortable { position: relative; }
    .table th.sortable::after { content: '↕'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.8rem; opacity: 0.5; }
    .table th.sort-asc::after { content: '↑'; opacity: 1; }
    .table th.sort-desc::after { content: '↓'; opacity: 1; }
    .checkbox-column { width: 40px; }
    .bulk-actions { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
    .bulk-actions.hidden { display: none; }
    .checkbox-input { margin: 0; }
    .table td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; }
    .table tbody tr:hover { background: #f8fafc; }
    .image-thumbnail { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
    .empty-state { padding: 60px 20px; text-align: center; }
    .empty-state i { font-size: 3rem; color: #cbd5e1; }
    .empty-state p { color: #94a3b8; margin-top: 12px; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-newspaper"></i> Kelola Artikel</h1>
</div>

<div class="header-card">
    <div class="header-info">
        <h3>Daftar Artikel</h3>
        <p>Kelola konten artikel yang tampil di aplikasi</p>
    </div>
    <a href="{{ url_for('web_create_article') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Buat Artikel Baru
    </a>
</div>

<div class="table-card">
    {% if articles %}
    <div class="bulk-actions hidden" id="bulkActions">
        <input type="checkbox" id="selectAll" class="checkbox-input">
        <label for="selectAll" style="font-size: 0.9rem; color: #475569; margin-right: 12px;">Pilih Semua</label>
        <button type="button" id="bulkDeleteBtn" class="btn btn-danger btn-sm" disabled>
            <i class="fas fa-trash"></i> Hapus Terpilih
        </button>
    </div>
    <table class="table" id="articlesTable">
        <thead>
            <tr>
                <th class="checkbox-column">
                    <input type="checkbox" id="selectAllHeader" class="checkbox-input">
                </th>
                <th class="sortable" data-column="id">ID</th>
                <th>Gambar</th>
                <th class="sortable" data-column="title">Judul</th>
                <th>Deskripsi</th>
                <th class="sortable" data-column="created_at">Tanggal</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for a in articles %}
            <tr data-article-id="{{ a.id }}">
                <td>
                    <input type="checkbox" class="row-checkbox checkbox-input" value="{{ a.id }}">
                </td>
                <td>#{{ a.id }}</td>
                <td>
                    {% if a.image %}
                    <img src="{{ url_for('uploaded_file', filename=a.image) }}" alt="Gambar Artikel" class="image-thumbnail">
                    {% else %}
                    <span style="color: #94a3b8;">Tidak ada</span>
                    {% endif %}
                </td>
                <td><strong>{{ a.title }}</strong></td>
                <td style="color: #64748b; font-size: 0.9rem;">{{ a.description[:100] }}{% if a.description|length > 100 %}...{% endif %}</td>
                <td style="font-size: 0.85rem; color: #94a3b8;">{{ a.created_at }}</td>
                <td>
                    <form action="{{ url_for('web_delete_article', article_id=a.id) }}" method="post" style="display:inline-block;" onsubmit="return confirm('Yakin ingin menghapus artikel ini?');">
                        <button class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <p>Belum ada artikel</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const table = document.getElementById('articlesTable');
    const tbody = table.querySelector('tbody');
    const bulkActions = document.getElementById('bulkActions');
    const selectAllHeader = document.getElementById('selectAllHeader');
    const selectAll = document.getElementById('selectAll');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');

    // Sorting functionality
    let currentSort = { column: 'created_at', direction: 'desc' };

    function sortTable(column, direction) {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aVal, bVal;

            if (column === 'id') {
                aVal = parseInt(a.querySelector('td:nth-child(2)').textContent.replace('#', ''));
                bVal = parseInt(b.querySelector('td:nth-child(2)').textContent.replace('#', ''));
            } else if (column === 'created_at') {
                aVal = new Date(a.cells[5].textContent.trim());
                bVal = new Date(b.cells[5].textContent.trim());
            } else {
                const columnIndex = ['id', 'image', 'title', 'description', 'created_at'].indexOf(column) + 1;
                aVal = a.cells[columnIndex]?.textContent?.trim() || '';
                bVal = b.cells[columnIndex]?.textContent?.trim() || '';
            }

            if (direction === 'asc') {
                return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
            } else {
                return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
            }
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    // Add click handlers to sortable headers
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', () => {
            const column = header.dataset.column;

            // Remove previous sort indicators
            document.querySelectorAll('.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });

            // Toggle sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            header.classList.add(`sort-${currentSort.direction}`);
            sortTable(column, currentSort.direction);
        });
    });

    // Bulk selection functionality
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
        const totalCheckboxes = rowCheckboxes.length;

        if (checkedBoxes.length > 0) {
            bulkActions.classList.remove('hidden');
            bulkDeleteBtn.disabled = false;
            bulkDeleteBtn.textContent = `Hapus Terpilih (${checkedBoxes.length})`;
        } else {
            bulkActions.classList.add('hidden');
            bulkDeleteBtn.disabled = true;
        }

        // Update select all checkboxes
        selectAll.checked = checkedBoxes.length === totalCheckboxes && totalCheckboxes > 0;
        selectAllHeader.checked = selectAll.checked;
    }

    // Select all functionality
    selectAllHeader.addEventListener('change', () => {
        const isChecked = selectAllHeader.checked;
        rowCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        selectAll.checked = isChecked;
        updateBulkActions();
    });

    selectAll.addEventListener('change', () => {
        const isChecked = selectAll.checked;
        rowCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        selectAllHeader.checked = isChecked;
        updateBulkActions();
    });

    // Individual checkbox changes
    rowCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });

    // Bulk delete functionality
    bulkDeleteBtn.addEventListener('click', () => {
        const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);

        if (selectedIds.length === 0) return;

        if (confirm(`Yakin ingin menghapus ${selectedIds.length} artikel terpilih?`)) {
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/web/articles/bulk-delete';

            selectedIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'article_ids';
                input.value = id;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        }
    });

    // Initial sort
    sortTable('created_at', 'desc');
    document.querySelector('[data-column="created_at"]').classList.add('sort-desc');
});
</script>
{% endblock %}
