{% extends 'base.html' %}

{% block title %}Kelola Produk - Admin{% endblock %}

{% block extra_css %}
<style>
    .page-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .page-header h1 { font-size: 1.8rem; font-weight: 700; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 12px; }
    .page-header i { color: #3b82f6; }
    .header-card { background: white; border-radius: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
    .header-info h3 { font-size: 1.1rem; font-weight: 600; color: #1e293b; margin: 0 0 4px 0; }
    .header-info p { font-size: 0.9rem; color: #64748b; margin: 0; }
    .btn { padding: 10px 18px; border-radius: 0; border: none; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    .table-card { background: white; border-radius: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .table { width: 100%; border-collapse: collapse; }
    .table thead { background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
    .table th { padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.85rem; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; user-select: none; }
    .table th:hover { background: #e2e8f0; }
    .table th.sortable { position: relative; }
    .table th.sortable::after { content: '↕'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.8rem; opacity: 0.5; }
    .table th.sort-asc::after { content: '↑'; opacity: 1; }
    .table th.sort-desc::after { content: '↓'; opacity: 1; }
    .checkbox-column { width: 40px; }
    .bulk-actions { 
        display: flex; 
        gap: 8px; 
        align-items: center; 
        padding: 12px 24px; 
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    .bulk-actions.hidden { display: none; }
    .bulk-actions label {
        font-size: 0.9rem;
        color: #475569;
        margin: 0;
        cursor: pointer;
        user-select: none;
        font-weight: 500;
    }
    .checkbox-input { 
        margin: 0; 
        cursor: pointer;
        width: 16px;
        height: 16px;
    }
    .table td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; }
    .table tbody tr:hover { background: #f8fafc; }
    .table tbody tr.clickable-row { cursor: pointer; }
    .image-thumbnail { width: 50px; height: 50px; object-fit: cover; border-radius: 0; }
    .empty-state { padding: 60px 20px; text-align: center; }
    .empty-state i { font-size: 3rem; color: #cbd5e1; }
    .empty-state p { color: #94a3b8; margin-top: 12px; }

    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background-color: white; padding: 24px; border-radius: 0; width: 100%; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0; }
    .modal-header h3 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; color: #1e293b; }
    .modal-close { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: #64748b; }
    .modal-body { margin-bottom: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #475569; font-size: 0.9rem; }
    .file-input-wrapper { border: 2px dashed #e2e8f0; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .file-input-wrapper:hover { border-color: #3b82f6; background: #f8fafc; }
    .file-input-wrapper i { font-size: 2rem; color: #94a3b8; margin-bottom: 8px; }
    .template-link { display: inline-flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #3b82f6; text-decoration: none; margin-top: 8px; }
    .template-link:hover { text-decoration: underline; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-box"></i> Kelola Produk</h1>
</div>

<div class="header-card">
    <div class="header-info">
        <h3>Daftar Produk</h3>
        <p>Kelola konten produk yang tampil di aplikasi</p>
    </div>
    <div style="display: flex; gap: 12px;">
        <button type="button" class="btn" style="background: #f8fafc; border: 1px solid #e2e8f0; color: #475569;" id="openImportModal">
            <i class="fas fa-file-import"></i> Import Bulk
        </button>
        <a href="{{ url_for('web_admin.web_create_product') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Buat Produk Baru
        </a>
    </div>
</div>

<!-- Modal Import -->
<div class="modal" id="importModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-import"></i> Bulk Import Produk</h3>
            <button class="modal-close" id="closeImportModal">&times;</button>
        </div>
        <form action="{{ url_for('web_admin.web_import_products') }}" method="POST" enctype="multipart/form-data">
            <div class="modal-body">
                <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 16px;">
                    Unggah file CSV atau Excel (.xlsx) untuk menambahkan banyak produk sekaligus.
                </p>
                <div class="form-group">
                    <label>Pilih File</label>
                    <div class="file-input-wrapper" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <div id="fileInfo">Klik untuk pilih file</div>
                        <input type="file" name="file" id="fileInput" accept=".csv, .xlsx, .xls" style="display: none;" onchange="updateFileInfo(this)">
                    </div>
                </div>
                <a href="{{ url_for('web_admin.web_download_product_template') }}" class="template-link">
                    <i class="fas fa-download"></i> Download Template CSV
                </a>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn" style="background: #f1f5f9; color: #475569;" id="cancelImport">Batal</button>
                <button type="submit" class="btn btn-primary">Mulai Import</button>
            </div>
        </form>
    </div>
</div>

<div class="table-card">
    {% if products %}
    <div class="bulk-actions hidden" id="bulkActions">
        <input type="checkbox" id="selectAll" class="checkbox-input">
        <label for="selectAll">Pilih Semua</label>
        <button type="button" id="bulkDeleteBtn" class="btn btn-danger btn-sm" disabled>
            <i class="fas fa-trash"></i> Hapus Terpilih
        </button>
    </div>
    <table class="table" id="productsTable">
        <thead>
            <tr>
                <th class="checkbox-column">
                    <input type="checkbox" id="selectAllHeader" class="checkbox-input">
                </th>
                <th class="sortable" data-column="id">ID</th>
                <th>Gambar</th>
                <th class="sortable" data-column="merek">Merek</th>
                <th class="sortable" data-column="nama">Nama</th>
                <th class="sortable" data-column="harga">Harga</th>
                <th class="sortable" data-column="kategori_penyakit">Kategori Penyakit</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for p in products %}
            <tr data-url="{{ url_for('web_admin.web_edit_product', product_id=p.id) }}" class="clickable-row">
                <td>
                    <input type="checkbox" class="row-checkbox checkbox-input" value="{{ p.id }}">
                </td>
                <td>{{ p.id }}</td>
                <td>
                    {% if p.image %}
                    <img src="{{ url_for('web_admin.uploaded_file', filename=p.image) }}" alt="Gambar Produk" class="image-thumbnail">
                    {% else %}
                    <span style="color: #94a3b8;">Tidak ada</span>
                    {% endif %}
                </td>
                <td><strong>{{ p.merek }}</strong></td>
                <td>{{ p.nama }}</td>
                <td>Rp {{ "{:,.0f}".format(p.harga|default(0, true)) }}</td>
                <td><span style="background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 0; font-size: 0.85rem;">{{ p.kategori_penyakit or '-' }}</span></td>
                <td>
                    <form action="{{ url_for('web_admin.web_delete_product', product_id=p.id) }}" method="post" style="display:inline-block;" onsubmit="return confirm('Yakin ingin menghapus produk ini?');">
                        <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <p>Belum ada produk</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const table = document.getElementById('productsTable');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const bulkActions = document.getElementById('bulkActions');
    const selectAllHeader = document.getElementById('selectAllHeader');
    const selectAll = document.getElementById('selectAll');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');

    // Sorting functionality
    let currentSort = { column: 'id', direction: 'desc' };

    function sortTable(column, direction) {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aVal, bVal;

            if (column === 'id') {
                aVal = parseInt(a.querySelector('td:nth-child(2)').textContent.replace('#', ''));
                bVal = parseInt(b.querySelector('td:nth-child(2)').textContent.replace('#', ''));
            } else if (column === 'harga') {
                // Extract numeric value from "Rp 1,000,000" format
                const aText = a.cells[5].textContent.trim().replace(/[^\d]/g, '');
                const bText = b.cells[5].textContent.trim().replace(/[^\d]/g, '');
                aVal = parseFloat(aText) || 0;
                bVal = parseFloat(bText) || 0;
            } else {
                const columnIndex = ['id', 'image', 'merek', 'nama', 'harga', 'kategori_penyakit'].indexOf(column) + 1;
                aVal = a.cells[columnIndex]?.textContent?.trim() || '';
                bVal = b.cells[columnIndex]?.textContent?.trim() || '';
            }

            if (direction === 'asc') {
                return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
            } else {
                return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
            }
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    // Add click handlers to sortable headers
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', () => {
            const column = header.dataset.column;

            // Remove previous sort indicators
            document.querySelectorAll('.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });

            // Toggle sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            header.classList.add(`sort-${currentSort.direction}`);
            sortTable(column, currentSort.direction);
        });
    });

    // Bulk selection functionality
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
        const totalCheckboxes = rowCheckboxes.length;

        if (checkedBoxes.length > 0) {
            bulkActions.classList.remove('hidden');
            bulkDeleteBtn.disabled = false;
            bulkDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> Hapus Terpilih (${checkedBoxes.length})`;
        } else {
            bulkActions.classList.add('hidden');
            bulkDeleteBtn.disabled = true;
        }

        // Update select all checkboxes
        selectAll.checked = checkedBoxes.length === totalCheckboxes && totalCheckboxes > 0;
        selectAllHeader.checked = selectAll.checked;
    }

    // Select all functionality
    if (selectAllHeader) {
        selectAllHeader.addEventListener('change', () => {
            const isChecked = selectAllHeader.checked;
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            selectAll.checked = isChecked;
            updateBulkActions();
        });
    }

    if (selectAll) {
        selectAll.addEventListener('change', () => {
            const isChecked = selectAll.checked;
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            selectAllHeader.checked = isChecked;
            updateBulkActions();
        });
    }

    // Individual checkbox changes
    rowCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            e.stopPropagation(); // Prevent row click
            updateBulkActions();
        });
    });

    // Bulk delete functionality
    if (bulkDeleteBtn) {
        bulkDeleteBtn.addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);

            if (selectedIds.length === 0) return;

            if (confirm(`Yakin ingin menghapus ${selectedIds.length} produk terpilih?`)) {
                // Create form and submit
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("web_admin.web_bulk_delete_products") }}';

                selectedIds.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'product_ids';
                    input.value = id;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    // Make rows clickable
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', (e) => {
            // Don't navigate if clicking checkbox, button, or form
            if (e.target.closest('input[type="checkbox"]') || 
                e.target.closest('button') || 
                e.target.closest('form')) {
                return;
            }
            window.location.href = row.dataset.url;
        });
    });

    // Initial sort
    sortTable('id', 'desc');
    const idHeader = document.querySelector('[data-column="id"]');
    if (idHeader) {
        idHeader.classList.add('sort-desc');
    }

    // Modal Handling
    const importModal = document.getElementById('importModal');
    const openImportBtn = document.getElementById('openImportModal');
    const closeImportBtn = document.getElementById('closeImportModal');
    const cancelImportBtn = document.getElementById('cancelImport');

    if (openImportBtn) {
        openImportBtn.addEventListener('click', () => {
            importModal.classList.add('show');
        });
    }

    const closeModal = () => {
        importModal.classList.remove('show');
    };

    if (closeImportBtn) closeImportBtn.addEventListener('click', closeModal);
    if (cancelImportBtn) cancelImportBtn.addEventListener('click', closeModal);
    
    // Close on click outside
    window.addEventListener('click', (e) => {
        if (e.target === importModal) closeModal();
    });
});

function updateFileInfo(input) {
    const fileInfo = document.getElementById('fileInfo');
    if (input.files && input.files[0]) {
        fileInfo.textContent = input.files[0].name;
        fileInfo.style.color = '#3b82f6';
        fileInfo.style.fontWeight = '600';
    } else {
        fileInfo.textContent = 'Klik untuk pilih file';
        fileInfo.style.color = '#94a3b8';
        fileInfo.style.fontWeight = '400';
    }
}
</script>
{% endblock %}