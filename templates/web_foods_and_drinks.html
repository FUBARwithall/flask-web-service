{% extends 'base.html' %}

{% block title %}Kelola Makanan & Minuman - Admin{% endblock %}

{% block extra_css %}
<style>
    .page-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .page-header h1 { font-size: 1.8rem; font-weight: 700; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 12px; }
    .page-header i { color: #3b82f6; }
    .header-card { background: white; border-radius: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
    .header-info h3 { font-size: 1.1rem; font-weight: 600; color: #1e293b; margin: 0 0 4px 0; }
    .header-info p { font-size: 0.9rem; color: #64748b; margin: 0; }
    .btn { padding: 10px 18px; border-radius: 0; border: none; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    .table-card { background: white; border-radius: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .table { width: 100%; border-collapse: collapse; }
    .table thead { background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
    .table th { padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.85rem; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; user-select: none; }
    .table th:hover { background: #e2e8f0; }
    .table th.sortable { position: relative; }
    .table th.sortable::after { content: '↕'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.8rem; opacity: 0.5; }
    .table th.sort-asc::after { content: '↑'; opacity: 1; }
    .table th.sort-desc::after { content: '↓'; opacity: 1; }
    .checkbox-column { width: 40px; }
    .bulk-actions { 
        display: flex; 
        gap: 8px; 
        align-items: center; 
        padding: 12px 24px; 
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    .bulk-actions.hidden { display: none; }
    .bulk-actions label {
        font-size: 0.9rem;
        color: #475569;
        margin: 0;
        cursor: pointer;
        user-select: none;
        font-weight: 500;
    }
    .checkbox-input { 
        margin: 0; 
        cursor: pointer;
        width: 16px;
        height: 16px;
    }
    .table td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; }
    .table tbody tr:hover { background: #f8fafc; }
    .table tbody tr.clickable-row { cursor: pointer; }
    .image-thumbnail { width: 50px; height: 50px; object-fit: cover; border-radius: 0; }
    .empty-state { padding: 60px 20px; text-align: center; }
    .empty-state i { font-size: 3rem; color: #cbd5e1; }
    .empty-state p { color: #94a3b8; margin-top: 12px; }

    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background-color: white; padding: 24px; border-radius: 0; width: 100%; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0; }
    .modal-header h3 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; color: #1e293b; }
    .modal-close { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: #64748b; }
    .modal-body { margin-bottom: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #475569; font-size: 0.9rem; }
    .file-input-wrapper { border: 2px dashed #e2e8f0; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .file-input-wrapper:hover { border-color: #3b82f6; background: #f8fafc; }
    .file-input-wrapper i { font-size: 2rem; color: #94a3b8; margin-bottom: 8px; }
    .template-link { display: inline-flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #3b82f6; text-decoration: none; margin-top: 8px; }
    .template-link:hover { text-decoration: underline; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-utensils"></i> Kelola Makanan dan Minuman</h1>
</div>

<!-- FOODS SECTION -->
<div class="header-card">
    <div class="header-info">
        <h3>Daftar Makanan</h3>
        <p>Kelola konten makanan yang tampil di aplikasi</p>
    </div>
    <div style="display: flex; gap: 12px;">
        <button type="button" class="btn" style="background: #f8fafc; border: 1px solid #e2e8f0; color: #475569;" onclick="openImportModal('foods')">
            <i class="fas fa-file-import"></i> Import Bulk
        </button>
        <a href="{{ url_for('web_admin.web_create_food') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Buat Makanan
        </a>
    </div>
</div>

<div class="table-card">
    {% if foods %}
    <div class="bulk-actions hidden" id="foodBulkActions">
        <input type="checkbox" id="foodSelectAll" class="checkbox-input">
        <label for="foodSelectAll" style="font-size: 0.9rem; color: #475569; margin-right: 12px;">Pilih Semua</label>
        <button type="button" id="foodBulkDeleteBtn" class="btn btn-danger btn-sm" disabled>
            <i class="fas fa-trash"></i> Hapus Terpilih
        </button>
    </div>
    <table class="table" id="foodsTable">
        <thead>
            <tr>
                <th class="checkbox-column">
                    <input type="checkbox" id="foodSelectAllHeader" class="checkbox-input">
                </th>
                <th class="sortable" data-column="id">ID</th>
                <th class="sortable" data-column="name">Nama</th>
                <th class="sortable" data-column="oil">Minyak</th>
                <th class="sortable" data-column="simple_carb">Karbohidrat</th>
                <th class="sortable" data-column="sugar">Gula</th>
                <th class="sortable" data-column="fiber">Serat</th>
                <th class="sortable" data-column="fermented">Fermentasi</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for f in foods %}
            <tr data-url="{{ url_for('web_admin.web_edit_food', food_id=f.id) }}" class="clickable-row">
                <td>
                    <input type="checkbox" class="food-row-checkbox checkbox-input" value="{{ f.id }}">
                </td>
                <td>#{{ f.id }}</td>
                <td>{{ f.name }}</td>
                <td>{{ f.oil }}</td>
                <td>{{ f.simple_carb }}</td>
                <td>{{ f.sugar }}</td>
                <td>{{ f.fiber }}</td>
                <td>{{ f.fermented }}</td>
                <td>
                    <form action="{{ url_for('web_admin.web_delete_food', food_id=f.id) }}" method="post" style="display:inline-block;" onsubmit="return confirm('Yakin ingin menghapus makanan ini?');">
                        <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <p>Belum ada makanan</p>
    </div>
    {% endif %}
</div>

<!-- DRINKS SECTION -->
<div class="header-card" style="margin-top: 32px;">
    <div class="header-info">
        <h3>Daftar Minuman</h3>
        <p>Kelola konten minuman yang tampil di aplikasi</p>
    </div>
    <div style="display: flex; gap: 12px;">
        <button type="button" class="btn" style="background: #f8fafc; border: 1px solid #e2e8f0; color: #475569;" onclick="openImportModal('drinks')">
            <i class="fas fa-file-import"></i> Import Bulk
        </button>
        <a href="{{ url_for('web_admin.web_create_drink') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Buat Minuman
        </a>
    </div>
</div>

<div class="table-card">
    {% if drinks %}
    <div class="bulk-actions hidden" id="drinkBulkActions">
        <input type="checkbox" id="drinkSelectAll" class="checkbox-input">
        <label for="drinkSelectAll" style="font-size: 0.9rem; color: #475569; margin-right: 12px;">Pilih Semua</label>
        <button type="button" id="drinkBulkDeleteBtn" class="btn btn-danger btn-sm" disabled>
            <i class="fas fa-trash"></i> Hapus Terpilih
        </button>
    </div>
    <table class="table" id="drinksTable">
        <thead>
            <tr>
                <th class="checkbox-column">
                    <input type="checkbox" id="drinkSelectAllHeader" class="checkbox-input">
                </th>
                <th class="sortable" data-column="id">ID</th>
                <th class="sortable" data-column="name">Nama</th>
                <th class="sortable" data-column="drink_type">Tipe Minuman</th>
                <th class="sortable" data-column="sugar">Gula</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for d in drinks %}
            <tr data-url="{{ url_for('web_admin.web_edit_drink', drink_id=d.id) }}" class="clickable-row">
                <td>
                    <input type="checkbox" class="drink-row-checkbox checkbox-input" value="{{ d.id }}">
                </td>
                <td>#{{ d.id }}</td>
                <td>{{ d.name }}</td>
                <td>{{ d.drink_type }}</td>
                <td>{{ d.sugar }}</td>   
                <td>
                    <form action="{{ url_for('web_admin.web_delete_drink', drink_id=d.id) }}" method="post" style="display:inline-block;" onsubmit="return confirm('Yakin ingin menghapus minuman ini?');">
                        <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <p>Belum ada minuman</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // ==================== FOODS TABLE LOGIC ====================
    const foodsTable = document.getElementById('foodsTable');
    if (foodsTable) {
        const foodBulkActions = document.getElementById('foodBulkActions');
        const foodSelectAllHeader = document.getElementById('foodSelectAllHeader');
        const foodSelectAll = document.getElementById('foodSelectAll');
        const foodBulkDeleteBtn = document.getElementById('foodBulkDeleteBtn');
        const foodRowCheckboxes = document.querySelectorAll('.food-row-checkbox');

        function updateFoodBulkActions() {
            const checkedBoxes = document.querySelectorAll('.food-row-checkbox:checked');
            const totalCheckboxes = foodRowCheckboxes.length;

            if (checkedBoxes.length > 0) {
                foodBulkActions.classList.remove('hidden');
                foodBulkDeleteBtn.disabled = false;
                foodBulkDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> Hapus Terpilih (${checkedBoxes.length})`;
            } else {
                foodBulkActions.classList.add('hidden');
                foodBulkDeleteBtn.disabled = true;
            }

            foodSelectAll.checked = checkedBoxes.length === totalCheckboxes && totalCheckboxes > 0;
            foodSelectAllHeader.checked = foodSelectAll.checked;
        }

        if (foodSelectAllHeader) {
            foodSelectAllHeader.addEventListener('change', () => {
                const isChecked = foodSelectAllHeader.checked;
                foodRowCheckboxes.forEach(checkbox => { checkbox.checked = isChecked; });
                foodSelectAll.checked = isChecked;
                updateFoodBulkActions();
            });
        }

        if (foodSelectAll) {
            foodSelectAll.addEventListener('change', () => {
                const isChecked = foodSelectAll.checked;
                foodRowCheckboxes.forEach(checkbox => { checkbox.checked = isChecked; });
                foodSelectAllHeader.checked = isChecked;
                updateFoodBulkActions();
            });
        }

        foodRowCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                updateFoodBulkActions();
            });
        });

        if (foodBulkDeleteBtn) {
            foodBulkDeleteBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.food-row-checkbox:checked')).map(cb => cb.value);
                if (selectedIds.length === 0) return;

                if (confirm(`Yakin ingin menghapus ${selectedIds.length} makanan terpilih?`)) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{{ url_for("web_admin.web_bulk_delete_foods") }}';

                    selectedIds.forEach(id => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'food_ids';
                        input.value = id;
                        form.appendChild(input);
                    });

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }
    }

    // ==================== DRINKS TABLE LOGIC ====================
    const drinksTable = document.getElementById('drinksTable');
    if (drinksTable) {
        const drinkBulkActions = document.getElementById('drinkBulkActions');
        const drinkSelectAllHeader = document.getElementById('drinkSelectAllHeader');
        const drinkSelectAll = document.getElementById('drinkSelectAll');
        const drinkBulkDeleteBtn = document.getElementById('drinkBulkDeleteBtn');
        const drinkRowCheckboxes = document.querySelectorAll('.drink-row-checkbox');

        function updateDrinkBulkActions() {
            const checkedBoxes = document.querySelectorAll('.drink-row-checkbox:checked');
            const totalCheckboxes = drinkRowCheckboxes.length;

            if (checkedBoxes.length > 0) {
                drinkBulkActions.classList.remove('hidden');
                drinkBulkDeleteBtn.disabled = false;
                drinkBulkDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> Hapus Terpilih (${checkedBoxes.length})`;
            } else {
                drinkBulkActions.classList.add('hidden');
                drinkBulkDeleteBtn.disabled = true;
            }

            drinkSelectAll.checked = checkedBoxes.length === totalCheckboxes && totalCheckboxes > 0;
            drinkSelectAllHeader.checked = drinkSelectAll.checked;
        }

        if (drinkSelectAllHeader) {
            drinkSelectAllHeader.addEventListener('change', () => {
                const isChecked = drinkSelectAllHeader.checked;
                drinkRowCheckboxes.forEach(checkbox => { checkbox.checked = isChecked; });
                drinkSelectAll.checked = isChecked;
                updateDrinkBulkActions();
            });
        }

        if (drinkSelectAll) {
            drinkSelectAll.addEventListener('change', () => {
                const isChecked = drinkSelectAll.checked;
                drinkRowCheckboxes.forEach(checkbox => { checkbox.checked = isChecked; });
                drinkSelectAllHeader.checked = isChecked;
                updateDrinkBulkActions();
            });
        }

        drinkRowCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                updateDrinkBulkActions();
            });
        });

        if (drinkBulkDeleteBtn) {
            drinkBulkDeleteBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.drink-row-checkbox:checked')).map(cb => cb.value);
                if (selectedIds.length === 0) return;

                if (confirm(`Yakin ingin menghapus ${selectedIds.length} minuman terpilih?`)) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '{{ url_for("web_admin.web_bulk_delete_drinks") }}';

                    selectedIds.forEach(id => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'drink_ids';
                        input.value = id;
                        form.appendChild(input);
                    });

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }
    }

    // ==================== CLICKABLE ROWS ====================
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', (e) => {
            if (e.target.closest('input[type="checkbox"]') || 
                e.target.closest('button') || 
                e.target.closest('form')) {
                return;
            }
            window.location.href = row.dataset.url;
        });
    });

    // ==================== SORTING LOGIC ====================
    let tableSorts = {
        'foodsTable': { column: 'id', direction: 'desc' },
        'drinksTable': { column: 'id', direction: 'desc' }
    };

    function sortTable(tableId, column, direction) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aVal, bVal;
            const header = table.querySelector(`th[data-column="${column}"]`);
            const columnIndex = Array.from(header.parentElement.children).indexOf(header);

            aVal = a.cells[columnIndex].textContent.trim();
            bVal = b.cells[columnIndex].textContent.trim();

            // Numeric sorting for ID and nutrition values
            const isNumeric = ['id', 'oil', 'simple_carb', 'sugar', 'fiber', 'fermented'].includes(column);
            if (isNumeric) {
                const aNum = parseFloat(aVal.replace('#', '')) || 0;
                const bNum = parseFloat(bVal.replace('#', '')) || 0;
                return direction === 'asc' ? aNum - bNum : bNum - aNum;
            }

            // String sorting
            return direction === 'asc' 
                ? aVal.localeCompare(bVal) 
                : bVal.localeCompare(aVal);
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', () => {
            const table = header.closest('table');
            const tableId = table.id;
            const column = header.dataset.column;
            const state = tableSorts[tableId];

            // Update direction
            if (state.column === column) {
                state.direction = state.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.column = column;
                state.direction = 'asc';
            }

            // UI feedback
            table.querySelectorAll('.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            header.classList.add(`sort-${state.direction}`);

            sortTable(tableId, column, state.direction);
        });
    });

    // Initial Sort
    sortTable('foodsTable', 'id', 'desc');
    sortTable('drinksTable', 'id', 'desc');
    document.querySelectorAll('th[data-column="id"]').forEach(h => h.classList.add('sort-desc'));

    // ==================== MODAL UI LOGIC ====================
    window.openImportModal = function(target) {
        const modal = document.getElementById('importModal');
        const label = document.getElementById('importTargetLabel');
        const input = document.getElementById('importTargetInput');
        const link = document.getElementById('templateDownloadLink');
        const fInput = document.getElementById('fileInput');
        const fInfo = document.getElementById('fileInfo');

        if (!modal) return;

        const isDrinks = target === 'drinks';
        label.textContent = isDrinks ? 'Minuman' : 'Makanan';
        input.value = target;
        link.href = `{{ url_for('web_admin.web_download_food_template') }}?target=${target}`;
        
        // Reset file input
        fInput.value = '';
        fInfo.textContent = 'Klik untuk pilih file';
        fInfo.style.color = '#94a3b8';
        fInfo.style.fontWeight = '400';
        
        modal.classList.add('show');
    };

    window.closeImportModal = function() {
        const modal = document.getElementById('importModal');
        if (modal) modal.classList.remove('show');
    };

    window.updateFileInfo = function(input) {
        const fInfo = document.getElementById('fileInfo');
        if (input.files && input.files[0]) {
            fInfo.textContent = input.files[0].name;
            fInfo.style.color = '#3b82f6';
            fInfo.style.fontWeight = '600';
        } else {
            fInfo.textContent = 'Klik untuk pilih file';
            fInfo.style.color = '#94a3b8';
            fInfo.style.fontWeight = '400';
        }
    };

    // Close modal on click outside
    window.addEventListener('click', (e) => {
        const modal = document.getElementById('importModal');
        if (e.target === modal) closeImportModal();
    });
});
</script>

<!-- Modal Import -->
<div class="modal" id="importModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-import"></i> Bulk Import <span id="importTargetLabel">Item</span></h3>
            <button class="modal-close" onclick="closeImportModal()">&times;</button>
        </div>
        <form action="{{ url_for('web_admin.web_import_foods_drinks') }}" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="target" id="importTargetInput" value="foods">
            <div class="modal-body">
                <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 16px;">
                    Unggah file CSV atau Excel (.xlsx) untuk menambahkan data secara massal.
                </p>
                <div class="form-group">
                    <label>Pilih File</label>
                    <div class="file-input-wrapper" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <div id="fileInfo">Klik untuk pilih file</div>
                        <input type="file" name="file" id="fileInput" accept=".csv, .xlsx, .xls" style="display: none;" onchange="updateFileInfo(this)">
                    </div>
                </div>
                <a id="templateDownloadLink" href="#" class="template-link">
                    <i class="fas fa-download"></i> Download Template CSV
                </a>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn" style="background: #f1f5f9; color: #475569;" onclick="closeImportModal()">Batal</button>
                <button type="submit" class="btn btn-primary">Mulai Import</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}