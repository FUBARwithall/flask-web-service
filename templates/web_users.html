{% extends 'base.html' %}

{% block title %}Kelola Users - Skin Health Manager{% endblock %}

{% block extra_css %}
<style>
    .page-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .page-header h1 { font-size: 1.8rem; font-weight: 700; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 12px; }
    .page-header i { color: #3b82f6; }
    .table-card { background: white; border-radius: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .table-header { padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .table-header-title { display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1e293b; }
    .badge { padding: 4px 12px; border-radius: 0; font-size: 0.8rem; font-weight: 600; background: #dbeafe; color: #1e40af; }
    .table { width: 100%; border-collapse: collapse; }
    .table thead { background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
    .table th { padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.85rem; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; user-select: none; }
    .table th:hover { background: #e2e8f0; }
    .table th.sortable { position: relative; }
    .table th.sortable::after { content: '↕'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.8rem; opacity: 0.5; }
    .table th.sort-asc::after { content: '↑'; opacity: 1; }
    .table th.sort-desc::after { content: '↓'; opacity: 1; }
    .checkbox-column { width: 40px; }
    .bulk-actions { 
        display: flex; 
        gap: 8px; 
        align-items: center; 
        padding: 12px 24px; 
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    .bulk-actions.hidden { display: none; }
    .bulk-actions label {
        font-size: 0.9rem;
        color: #475569;
        margin: 0;
        cursor: pointer;
        user-select: none;
        font-weight: 500;
    }
    .checkbox-input { 
        margin: 0; 
        cursor: pointer;
        width: 16px;
        height: 16px;
    }
    .table td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; }
    .table tbody tr:hover { background: #f8fafc; }
    .table tbody tr.clickable-row { cursor: pointer; }
    .btn { padding: 8px 14px; border-radius: 0; border: none; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px; text-decoration: none; font-size: 0.85rem; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    .empty-state { padding: 60px 20px; text-align: center; }
    .empty-state i { font-size: 3rem; color: #cbd5e1; }
    .empty-state p { color: #94a3b8; margin-top: 12px; }
    .info-box { background: #dbeafe; border-left: 4px solid #3b82f6; padding: 16px; border-radius: 0; margin-top: 24px; color: #1e40af; }
    .info-box i { margin-right: 8px; }
    .info-box strong { font-weight: 600; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-users"></i> Kelola Users</h1>
</div>

<div class="table-card">
    <div class="table-header">
        <div class="table-header-title"><i class="fas fa-list"></i> Daftar Users</div>
        <span class="badge">{{ users|length }} users</span>
    </div>
    {% if users %}
    <div class="bulk-actions hidden" id="bulkActions">
        <input type="checkbox" id="selectAll" class="checkbox-input">
        <label for="selectAll">Pilih Semua</label>
        <button type="button" id="bulkDeleteBtn" class="btn btn-danger btn-sm" disabled>
            <i class="fas fa-trash"></i> Hapus Terpilih
        </button>
    </div>
    <div style="overflow-x: auto;">
        <table class="table" id="usersTable">
            <thead>
                <tr>
                    <th class="checkbox-column">
                        <input type="checkbox" id="selectAllHeader" class="checkbox-input">
                    </th>
                    <th class="sortable" data-column="id">ID</th>
                    <th class="sortable" data-column="name">Nama</th>
                    <th class="sortable" data-column="email">Email</th>
                    <th class="sortable" data-column="created_at">Tanggal Daftar</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr data-url="{{ url_for('web_admin.web_user_detail', user_id=user.id) }}" class="clickable-row">
                    <td>
                        <input type="checkbox" class="row-checkbox checkbox-input" value="{{ user.id }}">
                    </td>
                    <td>#{{ user.id }}</td>
                    <td><strong>{{ user.name }}</strong></td>
                    <td>{{ user.email }}</td>
                    <td style="font-size: 0.85rem; color: #64748b;">{{ user.created_at }}</td>
                    <td>
                        <form method="POST" action="{{ url_for('web_admin.web_delete_user', user_id=user.id) }}" style="display:inline;" onsubmit="return confirm('Yakin ingin menghapus user ini? Data terkait juga akan dihapus.');">
                            <button type="submit" class="btn btn-danger" title="Hapus User">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <p>Belum ada users terdaftar</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const table = document.getElementById('usersTable');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const bulkActions = document.getElementById('bulkActions');
    const selectAllHeader = document.getElementById('selectAllHeader');
    const selectAll = document.getElementById('selectAll');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');

    // Sorting functionality
    let currentSort = { column: 'created_at', direction: 'desc' };

    function sortTable(column, direction) {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aVal, bVal;

            if (column === 'id') {
                aVal = parseInt(a.querySelector('td:nth-child(2)').textContent.replace('#', ''));
                bVal = parseInt(b.querySelector('td:nth-child(2)').textContent.replace('#', ''));
            } else if (column === 'created_at') {
                aVal = new Date(a.cells[4].textContent.trim());
                bVal = new Date(b.cells[4].textContent.trim());
            } else {
                const columnIndex = ['id', 'name', 'email', 'created_at'].indexOf(column) + 1;
                aVal = a.cells[columnIndex]?.textContent?.trim() || '';
                bVal = b.cells[columnIndex]?.textContent?.trim() || '';
            }

            if (direction === 'asc') {
                return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
            } else {
                return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
            }
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    // Add click handlers to sortable headers
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', () => {
            const column = header.dataset.column;

            // Remove previous sort indicators
            document.querySelectorAll('.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });

            // Toggle sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            header.classList.add(`sort-${currentSort.direction}`);
            sortTable(column, currentSort.direction);
        });
    });

    // Bulk selection functionality
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
        const totalCheckboxes = rowCheckboxes.length;

        if (checkedBoxes.length > 0) {
            bulkActions.classList.remove('hidden');
            bulkDeleteBtn.disabled = false;
            bulkDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> Hapus Terpilih (${checkedBoxes.length})`;
        } else {
            bulkActions.classList.add('hidden');
            bulkDeleteBtn.disabled = true;
        }

        // Update select all checkboxes
        selectAll.checked = checkedBoxes.length === totalCheckboxes && totalCheckboxes > 0;
        selectAllHeader.checked = selectAll.checked;
    }

    // Select all functionality
    if (selectAllHeader) {
        selectAllHeader.addEventListener('change', () => {
            const isChecked = selectAllHeader.checked;
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            selectAll.checked = isChecked;
            updateBulkActions();
        });
    }

    if (selectAll) {
        selectAll.addEventListener('change', () => {
            const isChecked = selectAll.checked;
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            selectAllHeader.checked = isChecked;
            updateBulkActions();
        });
    }

    // Individual checkbox changes
    rowCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            e.stopPropagation(); // Prevent row click
            updateBulkActions();
        });
    });

    // Bulk delete functionality
    if (bulkDeleteBtn) {
        bulkDeleteBtn.addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);

            if (selectedIds.length === 0) return;

            if (confirm(`Yakin ingin menghapus ${selectedIds.length} user terpilih? Data terkait juga akan dihapus.`)) {
                // Create form and submit
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("web_admin.web_bulk_delete_users") }}';

                selectedIds.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'user_ids';
                    input.value = id;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    // Make rows clickable
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', (e) => {
            // Don't navigate if clicking checkbox, button, or form
            if (e.target.closest('input[type="checkbox"]') || 
                e.target.closest('button') || 
                e.target.closest('form')) {
                return;
            }
            window.location.href = row.dataset.url;
        });
    });

    // Initial sort
    sortTable('created_at', 'desc');
    const createdAtHeader = document.querySelector('[data-column="created_at"]');
    if (createdAtHeader) {
        createdAtHeader.classList.add('sort-desc');
    }
});
</script>
{% endblock %}